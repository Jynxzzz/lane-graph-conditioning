å°±æ˜¯è¿™ä¸ªå‘³é“å“¥ï¼ï¼ä½ å·²ç»è¸©åˆ°äº†â€œæ•°æ®ç»“æ„è®¾è®¡çš„åœ°åŸºâ€ã€‚

æˆ‘ä»¬æ¥æŠŠå®ƒå†™æˆä¸€å¥—ä½ èƒ½é•¿æœŸè´¯å½»çš„è®¾è®¡è§„èŒƒï¼Œç”¨äºæ‰€æœ‰æœªæ¥çš„ Diffusion / LSTM / Transformer é¡¹ç›®ã€‚

â¸»

âœ… ObsiTraj Dataset è®¾è®¡å“²å­¦ï¼ˆv1.0ï¼‰

ğŸš§ ä¸€ã€sample é¡¶å±‚ï¼šä¾›æ¨¡å‹è®­ç»ƒ/è¯„ä¼°ç”¨çš„æ•°æ®
	â€¢	sdc_history: (H, 2) tensorï¼Œå†å²è½¨è¿¹
	â€¢	sdc_future: (F, 2) tensorï¼Œæœªæ¥è½¨è¿¹ï¼ˆç›‘ç£ä¿¡å·ï¼‰
	â€¢	agent_mask: (H,) or (H+F,) å¯é€‰ï¼Œç”¨äºæ©ç æ— æ•ˆæ•°æ®
	â€¢	rel_path: strï¼Œåœºæ™¯è·¯å¾„ï¼ˆç”¨äº debug æˆ– error å®šä½ï¼‰
	â€¢	idx: intï¼Œå½“å‰ sample çš„ç¼–å·ï¼ˆå¯é€‰ï¼‰
	â€¢	lane_tokens, scene_tokens, lane_graph_tensor: è‹¥æ¨¡å‹éœ€è¦ token è¾“å…¥ï¼Œä¹Ÿåº”æ”¾åœ¨é¡¶å±‚
	â€¢	âœ… âœ… æ‰€æœ‰ tensor éƒ½åº”ä¸º torch.Tensorï¼Œå½¢çŠ¶æ¸…æ™°ï¼Œæ–¹ä¾¿ DataLoader æ‹¼æ¥

â¸»

ğŸ§  äºŒã€sample["scenario"]ï¼šæ‰€æœ‰ä¸­é—´æ•°æ®ä¸å¯è§†åŒ–æ”¯æŒå­—æ®µ

å­—æ®µå	å†…å®¹	æ¥æº
sdc_traj_bev	(T, 2) arrayï¼Œå®Œæ•´è½¨è¿¹åœ¨ ego åæ ‡ç³»ä¸­çš„è¡¨ç¤º	ToBEV ä¸­ç”Ÿæˆ
lane_graph_bev	dictï¼Œå˜æ¢åçš„ lane graph	ToBEV ä¸­ç”Ÿæˆ
ego_pose	(pos, heading)ï¼Œå½“å‰ ego ä½ç½®ä¸æœå‘	extract_ego_info()
w2e	callable or matrixï¼Œåæ ‡å˜æ¢å‡½æ•°	build_local_transform()
objects[*]["position_bev"]	æ‰€æœ‰è½¦è¾†è½¨è¿¹çš„å˜æ¢ç»“æœ	transform_all_trajectories()
rel_path	åŒä¸Šï¼Œç”¨äºè¿½è¸ª	åŸå§‹æ•°æ®æºå¸¦æˆ– transform åŠ å…¥

ğŸ›‘ ä¸è¦æŠŠ sdc_traj_bev ç›´æ¥æå‡åˆ° sample é¡¶å±‚ â€”â€” é‚£æ˜¯å¯è§†åŒ–ç»„ä»¶éœ€è¦çš„ï¼Œä¸æ˜¯æ¨¡å‹è®­ç»ƒç”¨å­—æ®µã€‚

â¸»

ğŸ§± ä¸‰ã€æ¨¡å—èŒè´£ï¼ˆtransform è®¾è®¡ï¼‰

transform å	åŠŸèƒ½	ä¿®æ”¹ sample
ToBEV()	åŠ å…¥ w2e, lane_graph_bev, sdc_traj_bev ç­‰	sample[â€œscenarioâ€]
ExtractModelInput()	æå– history / future / mask	sample é¡¶å±‚
ToTensor()	è½¬æˆ tensorï¼Œç¡®ä¿ç±»å‹ä¸€è‡´	sample é¡¶å±‚
Normalize()ï¼ˆå¯é€‰ï¼‰	å¯¹ history/future åšå½’ä¸€åŒ–	sample é¡¶å±‚


â¸»

ğŸ§ª å››ã€æ£€æŸ¥å·¥å…·ï¼šè°ƒè¯• sample çš„ç»“æ„

ä½ å¯ä»¥å†™ä¸€ä¸ªå‡½æ•°ï¼Œåœ¨ transform æµæ¯ä¸€æ­¥ä¹‹åè°ƒç”¨ï¼š

def debug_sample_structure(sample):
    print("== Sample Top-Level Keys ==")
    for k, v in sample.items():
        if k != "scenario":
            print(f"{k}: {type(v)}, shape: {getattr(v, 'shape', '-')}")
    print("== Scenario Substructure ==")
    for k, v in sample.get("scenario", {}).items():
        print(f"  scenario[{k}]: {type(v)}, shape: {getattr(v, 'shape', '-')}")


â¸»

âœ… ç»“è¯­ï¼šæ¨¡å—è§£è€¦ï¼Œæ•°æ®æ¸…æ™°ï¼Œè®­ç»ƒæ‰ä¸è¿·è·¯

ä½ ç°åœ¨çš„ç—›ç‚¹ï¼Œå…¶å®æ˜¯æŠŠâ€œä¸´æ—¶è°ƒè¯•å­—æ®µâ€å’Œâ€œæ¨¡å‹è®­ç»ƒå­—æ®µâ€æ··åœ¨ä¸€èµ·å¯¼è‡´çš„ã€‚

ä»ä»Šå¤©å¼€å§‹ï¼ŒæŠŠä¸¤ç±»ä¿¡æ¯æ‹†å¼€ï¼Œæ•´ä¸ªç³»ç»Ÿç«‹é©¬æ¸…æ™°ï¼

ä½ è¦æˆ‘å¸®ä½ é‡æ„ ToBEV() çš„æœ€ç»ˆç‰ˆé€»è¾‘å—ï¼Ÿå¸¦ä¸Šæ‰€æœ‰è¿™äº›è®¾è®¡è§„åˆ™ï¼Ÿ


éå¸¸ä¸¥è‚ƒä¹Ÿéå¸¸å…³é”®çš„é—®é¢˜ã€‚æˆ‘ä»¬ä¸€èµ·æŠŠå®ƒè®²æ¸…æ¥šâ€”â€”åˆ°åº• sample ç»“æ„åº”è¯¥åŒ…å«ä»€ä¹ˆï¼Ÿæ˜¯ä¿ç•™åŸå§‹ scenarioï¼Œè¿˜æ˜¯æå‡å…³é”®å­—æ®µï¼Ÿ

â¸»

ğŸ¯ é—®é¢˜æ ¸å¿ƒï¼šsample çš„ç›®æ ‡ç»“æ„è®¾è®¡æ˜¯è®­ç»ƒæ¥å£çš„å¥‘çº¦

ä½ è¦é—®çš„å…¶å®æ˜¯ï¼š

â€œæˆ‘ä»¬çš„æ•°æ®å¤„ç†é“¾æ¡æœ€ç»ˆåº”è¯¥è¾“å‡ºå“ªäº›å­—æ®µç»™æ¨¡å‹è®­ç»ƒç”¨ï¼Ÿâ€

è¿™æ˜¯ dataset çš„èŒè´£ã€‚ä¸‹é¢ä»æ•°æ®ç»“æ„è®¾è®¡è§’åº¦å‘Šè¯‰ä½ æœ€ä½³åšæ³•ã€‚

â¸»

âœ… æœ€æ¨èç»“æ„ï¼šsample = {input tensors + metadata}ï¼ŒåŸå§‹æ•°æ®ä¿ç•™åœ¨ sample["scenario"]

sample = {
    "sdc_history": Tensor(...),         # (H, 2)
    "sdc_future": Tensor(...),          # (F, 2)
    "scenario": {
        "rel_path": ...,
        "sdc_traj_bev": [...],          # åŸå§‹è½¨è¿¹åœ¨ BEV ä¸­çš„å½¢å¼
        "lane_graph_bev": {...},        # lane graph ç»“æ„
        "w2e": ...,
        "ego_pose": (x, y, heading),
        ...
    },
    "rel_path": str,
    "idx": int,
}

è§£é‡Šï¼š
	â€¢	ğŸ”§ ä½ çœŸæ­£è®­ç»ƒéœ€è¦çš„å­—æ®µï¼Œå¦‚ sdc_historyã€sdc_future åº”è¯¥åœ¨ sample é¡¶éƒ¨ã€‚
	â€¢	ğŸ§  ä½ æƒ³è°ƒè¯•å¯è§†åŒ–çš„å…ƒæ•°æ®ã€åæ ‡å˜æ¢ç­‰åº”è¯¥ä¿å­˜åœ¨ sample["scenario"]ï¼Œä¸æ±¡æŸ“è®­ç»ƒç”¨å­—æ®µã€‚
	â€¢	âœ… è¿™æ ·ï¼ŒDataLoader â†’ æ¨¡å‹è®­ç»ƒ å°±åªç®¡ä¸Šå±‚å­—æ®µï¼Œå¯è§†åŒ–/è°ƒè¯• åˆ™ä» sample["scenario"] ä¸­æ‹¿ã€‚

â¸»

âŒ ä¸æ¨èï¼šæŠŠæ‰€æœ‰æ•°æ®éƒ½ç›´æ¥ flatten åˆ° sample é¡¶éƒ¨

sample = {
    "sdc_history": Tensor(...),
    "sdc_traj_bev": np.array(...),
    "w2e": ...,
    "lane_graph_bev": ...,
    ...
}

	â€¢	ç¼ºç‚¹ï¼š
	â€¢	éš¾ä»¥ç»´æŠ¤ï¼ˆtransform å¯èƒ½äº’ç›¸è¦†ç›–å­—æ®µï¼‰
	â€¢	æ•°æ®æµæ±¡æŸ“ä¸¥é‡ï¼ˆä½ ä¸çŸ¥é“æŸä¸ªå­—æ®µæ˜¯è°åŠ çš„ã€åœ¨å“ªä¸€æ­¥ç”Ÿæˆçš„ï¼‰

â¸»

âœ… ç»“è®ºï¼ˆè®¾è®¡åŸåˆ™ï¼‰

ç›®æ ‡	å»ºè®®åšæ³•
æ¨¡å‹è®­ç»ƒå­—æ®µ	æ”¾åœ¨ sample["sdc_history"], sample["sdc_future"], sample["agent_mask"] ç­‰ä¸€çº§å­—æ®µ
ä¸­é—´å¯è§†åŒ–/è°ƒè¯•/è¾…åŠ©ä¿¡æ¯	æ”¾åœ¨ sample["scenario"]["xxx"]
åšæŒæ¨¡å—åŒ–	æ¯ä¸ª transform æ˜ç¡®è¾“å…¥è¾“å‡ºï¼Œä¸ç›´æ¥è¦†ç›– sample é¡¶å±‚å­—æ®µ


â¸»

ğŸ”§ ç¤ºä¾‹ transform æµ

transform = Compose([
    ToBEV(),                      # åœ¨ sample["scenario"] ä¸­åŠ  BEV æ•°æ®
    ExtractModelInput(...),      # æå– history, future ç­‰ä½œä¸ºè®­ç»ƒå­—æ®µ
    ToTensor(),                  # è½¬ä¸º Tensor
])


â¸»

ğŸ§  è®°ä½ï¼šsample æ˜¯æœ€ç»ˆæ¨¡å‹çœ‹è§çš„æ•°æ®

å®ƒçš„ç»“æ„è®¾è®¡æ˜¯æ•´ä¸ªæ•°æ® pipeline çš„â€œå¯¹å¤–æ¥å£â€ï¼Œä½ åº”è¯¥ç¡®ä¿å®ƒï¼š
	â€¢	ç®€æ´ï¼ˆæ¨¡å‹åªç”¨å®ƒçš„é¡¶å±‚å­—æ®µï¼‰
	â€¢	ç»“æ„åŒ–ï¼ˆè°ƒè¯•ä¿¡æ¯éƒ½æ”¾åœ¨ scenario ä¸­ï¼‰
	â€¢	ä¸æ±¡æŸ“ï¼ˆä¸æŠŠ BEV ä¹‹ç±»å¡åˆ°æ¨¡å‹ input å­—æ®µé‡Œï¼‰

â¸»

å¦‚ä½ åŒæ„è¿™ä¸ªè®¾è®¡ç†å¿µï¼Œæˆ‘å¯ä»¥å¸®ä½ ï¼š
	1.	æ˜ç¡®è§„å®š sample çš„å­—æ®µ schemaï¼›
	2.	é‡æ„ä½ ç°æœ‰çš„ ToBEV å’Œ ExtractModelInputï¼›
	3.	å®šä¹‰ä¸€ä¸ªæ‰“å° sample ç»“æ„çš„è°ƒè¯•å‡½æ•°ï¼ˆæ¯æ¬¡ transform åæ£€æŸ¥ç»“æ„ï¼‰ã€‚

è¦ç°åœ¨å¼€å§‹å—ï¼Ÿ
